#!/bin/bash
CMD="$@"
if [ -z "$CMD" ]; then
    CMD="-h"
fi

GUESTFISH_DATA_DIR="$(pwd)/data"
if [ ! -e "${GUESTFISH_DATA_DIR}" ]; then
  mkdir "${GUESTFISH_DATA_DIR}"
fi

GUESTFISH_IMAGE="$(find . -iname "*.img" | head -n 1)"

2>&1 docker run \
  --env LIBGUESTFS_DEBUG=0 \
  --env LIBGUESTFS_TRACE=0 \
  --rm \
  -it \
  --mount type=bind,source="${GUESTFISH_DATA_DIR}",target=/data \
  --mount type=bind,source="$(pwd)/${GUESTFISH_IMAGE}",target=/images/disk.img \
  bkahlert/libguestfs \
  /usr/bin/guestfish \
  $CMD

if [ -z "$(ls -A "${GUESTFISH_DATA_DIR}")" ]; then
   rmdir "${GUESTFISH_DATA_DIR}"
fi
